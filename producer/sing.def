Bootstrap: docker
From: python:3
%environment
        export PYTHONUNBUFFERED=1
%post
        mkdir /code
        cd /code
        touch /code/requirements.txt
        cat > /code/requirements.txt <<EOF
kafka-python==2.0.1
protobuf3==0.2.1
EOF
        apt-get update -y
        apt-get install sudo
        sudo echo "Europe/Amsterdam" > /etc/timezone
        pip install -r /code/requirements.txt
        touch /code/producer.py
        cat > /code/producer.py <<EOF
from time import sleep
from kafka import KafkaProducer
import random, string, datetime
from protobuf3.message import Message
from protobuf3.fields import StringField, Int32Field, MessageField

producer = KafkaProducer(bootstrap_servers=['localhost:19092'])


def __id_generator__(size=6, chars=string.ascii_uppercase + string.digits + string.ascii_lowercase):
    return ''.join(random.choice(chars) for _ in range(size))


def generate_random_1000_transaction_data(data_obj):
    for _ in range(0,100):
        transaction = Transaction()
        transaction.transaction_id = __id_generator__()
        transaction.account_number = random.randint(1, 50)
        transaction.transaction_reference = __id_generator__()
        transaction.transaction_datetime = datetime.datetime.now().isoformat()
        transaction.amount = random.randint(1, 100)
        data_obj.data.append(transaction)
    return data_obj


"""schema"""
class Transaction(Message):
    transaction_id = StringField(field_number=1, required=True)
    account_number = Int32Field(field_number=2, required=True)
    transaction_reference = StringField(field_number=3, required=True)
    transaction_datetime = StringField(field_number=4, required=True)
    amount = Int32Field(field_number=5, required=True)

class Details(Message):
    data = MessageField(field_number=1, repeated=True, message_cls=Transaction)


for _ in range(10000):
    data_obj = Details()
    details = generate_random_1000_transaction_data(data_obj)
    print(details)
    data = details.encode_to_bytes()
    producer.send('mytopic', value=data)
    sleep(1)
EOF
